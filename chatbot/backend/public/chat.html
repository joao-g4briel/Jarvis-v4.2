<!DOCTYPE html>
<html>
<head>
	<title>ChatBot</title>
	<style>
		body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; }
		#chat { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
		.message { margin: 10px 0; padding: 5px; }
		.user { text-align: right; color: blue; background-color: #f0f8ff; }
		.assistant { text-align: left; color: green; background-color: #f5fff0; }
		input, button { padding: 10px; margin: 5px; }
		#input { width: 70%; }
	</style>
</head>
<body>
	<h2>ChatBot</h2>
	<div id="chat"></div>
	<input type="text" id="input" placeholder="Digite sua mensagem..." onkeypress="if(event.key==='Enter') sendMessage()">
	<button onclick="sendMessage()">Enviar</button>
	<button onclick="logout()">Logout</button>

	<script>
		let userId = localStorage.getItem('userId');
		let conversationId = null;

		// Detecta ambiente e define a URL base do backend
		const backendUrl = (window.location.hostname.includes('localhost') || window.location.hostname === '127.0.0.1')
			? 'http://localhost:3000'
			: 'https://wggks448w0wok8okwo0ww4w0.coolify.dtecchat.qzz.io';

		if (!userId) {
			window.location.href = 'login.html';
		}

		async function createConversation() {
			const res = await fetch(`${backendUrl}/conversations`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ userId, title: 'Conversa ' + new Date().toLocaleString() })
			});
			const data = await res.json();
			conversationId = data.conversationId;
		}

		async function loadMessages() {
			if (!conversationId) await createConversation();
            
			const res = await fetch(`${backendUrl}/messages/${conversationId}`);
			const messages = await res.json();
            
			const chatDiv = document.getElementById('chat');
			chatDiv.innerHTML = messages.map(m => 
				`<div class="message ${m.role}"><strong>${m.role}:</strong> ${m.content}</div>`
			).join('');
			chatDiv.scrollTop = chatDiv.scrollHeight;
		}

		async function sendMessage() {
			const input = document.getElementById('input');
			const message = input.value;
			if (!message) return;

			// Mostrar mensagem do usu√°rio
			const chatDiv = document.getElementById('chat');
			chatDiv.innerHTML += `<div class="message user"><strong>user:</strong> ${message}</div>`;
			chatDiv.scrollTop = chatDiv.scrollHeight;

			const res = await fetch(`${backendUrl}/chat`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ message, userId, conversationId })
			});

			const data = await res.json();

			// Mostrar resposta do bot
			chatDiv.innerHTML += `<div class="message assistant"><strong>assistant:</strong> ${data.reply}</div>`;
			chatDiv.scrollTop = chatDiv.scrollHeight;
            
			input.value = '';
		}

		function logout() {
			localStorage.removeItem('userId');
			window.location.href = 'login.html';
		}

		loadMessages();
	</script>
</body>
</html>
(placeholder)
